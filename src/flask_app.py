import os
from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS
import random

from ai_code_scorer import AICodeScorer

app = Flask(__name__)
CORS(app)

scorer = AICodeScorer(api_key=os.environ["API_KEY"])


@app.route("/get-score", methods=["POST"])
def get_score():
    data = request.json
    repo_url = data.get("url")

    comments = {
        10: [
            "æ‚¨å†™ä»£ç æ¯”é›·å†›è¿˜ä¼˜é›…",
            "ææ‹‰æ–¯è„±è¢œå­è§äº†æ‚¨éƒ½å¾—å«å£°å“¥",
            "æ‚¨çš„ä»£ç ï¼Œé¾Ÿå”éƒ½è§‰å¾—ä¼˜é›…",
            "å‡†ç¡®æ— è¯¯ï¼Œå®Œç¾æ— ç¼ºï¼Œç»™äººæ·±åˆ»å°è±¡ï¼",
            "ä½œä¸ºå…¸èŒƒï¼Œæ¯«æ— ç–‘é—®åœ°å€¼å¾—æ»¡åˆ†ã€‚",
        ],
        9: [
            "å‘ï¼Œè¿™ä¸ªå°±å«ä¸“ä¸š",
            "æƒ³å­¦å•Šï¼Ÿæˆ‘æ•™ä½ å•Š",
            "ä¼˜é›…ï¼ŒçœŸtmdçš„ä¼˜é›…",
            "éå¸¸æ¥è¿‘å®Œç¾ï¼Œåªå·®ä¸€ç‚¹ç‚¹å°±èƒ½æ»¡åˆ†ã€‚",
            "è½»å¾®çš„ä¸è¶³ä¹‹å¤„ï¼Œæ•´ä½“è¡¨ç°ä»¤äººå°è±¡æ·±åˆ»ã€‚",
        ],
        8: [
            "AIéƒ½å¾—å‘æ‚¨å­¦ä¹ ",
            "å¾ˆå‡ºè‰²ï¼Œä½†ç¼ºä¹ä¸€äº›åˆ›æ–°å…ƒç´ ã€‚",
            "è´¨é‡ä¼˜ç§€ï¼Œä½†å°ç»†èŠ‚ä¼šè®©å®ƒæ›´å®Œç¾ã€‚",
        ],
        7: [
            "äººå¦‚æœæ²¡æœ‰æ¢¦æƒ³ï¼Œé‚£è·Ÿå’¸é±¼æœ‰ä»€ä¹ˆåˆ†åˆ«?",
            "ä¸é”™ï¼Œå€¼å¾—ä¸€çœ‹ï¼Œä½†ä»æœ‰æå‡ç©ºé—´ã€‚",
            "æ•´ä½“è¡¨ç°è‰¯å¥½ï¼Œä½†è¿˜æœ‰ä¸€äº›å°ç‘•ç–µã€‚",
        ],
        6: [
            "60åˆ†ä¸‡å²ï¼Œå¤šä¸€ä»½æµªè´¹??",
            "èƒ½è·‘å°±è¡Œäº†ï¼Œè¦å•¥è‡ªè¡Œè½¦??",
            "ç»†èŠ‚ä¸Šæœ‰ç‚¹ä¸œæ‹¼è¥¿å‡‘ï¼Œå¯ä»¥æ›´ç²¾è‡´ä¸€äº›ã€‚",
            "æœ‰æ½œåŠ›ï¼Œä½†éœ€è¦æ›´å¤šæ‰“ç£¨å’Œä¼˜åŒ–ã€‚",
        ],
        5: [
            "æ±‚æ‚¨äº†ï¼Œåšä¸ªçœŸæ­£çš„coderå§",
            "åŠé€”è€ŒåºŸï¼Œè™½ç„¶æœ‰ç‚¹è¿›æ­¥ï¼Œä½†è·ç¦»ä¼˜ç§€è¿˜æœ‰å¾ˆå¤§å·®è·ã€‚",
            "ä¸­è§„ä¸­çŸ©ï¼Œä½†å®Œå…¨æ²¡æœ‰è¶…å‡ºé¢„æœŸçš„åœ°æ–¹ã€‚",
        ],
        4: [
            "æ‚¨çš„ä»£ç æ˜¯ä¸ä½“è‚²è€å¸ˆæ•™çš„?",
            "æœ‰ä¸€äº›äº®ç‚¹ï¼Œä½†æ•´ä½“ä¸Šä¾ç„¶ä¸å¤Ÿå¥½ã€‚",
            "è¿˜æ˜¯å¾ˆå·®ï¼ŒåŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆå€¼å¾—ç§°é“çš„åœ°æ–¹ã€‚",
        ],
        3: [
            "æ‚¨çš„ä»£ç çœ‹å¾—æˆ‘è„‘å£³ç–¼",
            "åªæ˜¯å‹‰å¼ºè¿‡äº†åº•çº¿ï¼Œæ ¹æœ¬æ— æ³•ä»¤äººæ»¡æ„ã€‚",
            "å¤§å¤šæ•°åœ°æ–¹éƒ½éœ€è¦é‡åšï¼Œè¿™æ ·çš„è´¨é‡æ— æ³•å®¹å¿ã€‚",
        ],
        2: [
            "æ‚¨è¿™ä»£ç æ˜¯ä¸æ˜¯å‡Œæ™¨ä¸¤ç‚¹å†™çš„ï¼Ÿï¼",
            "æ‚¨çš„ä»£ç ï¼Œå°±æ˜¯bugæœ¬å“¥",
            "åªæœ‰ä¸¤åˆ†ï¼Œè¶³ä»¥è¯æ˜ç¼ºä¹åŠªåŠ›ã€‚",
            "è¿™ä»…æ¯”ä¸€åˆ†å¥½ä¸€ç‚¹ï¼Œä½†ä¾ç„¶ç³Ÿç³•é€é¡¶ã€‚",
        ],
        1: [
            "GPT3å†™çš„ä»£ç éƒ½æ¯”è¿™å¥½",
            "æ‚¨çš„ä»£ç è¿›æ­¥ç©ºé—´æŒºå¤§çš„ğŸ™‚",
            "è¿™å®Œå…¨ä¸åŠæ ¼ï¼Œç®€ç›´æ˜¯ä»¤äººå¤±æœ›çš„ä½œå“ã€‚",
            "è¿™å°±åƒæ˜¯å¤±è´¥çš„å®éªŒï¼Œæ¯«æ— ä»·å€¼ã€‚",
        ],
        0: [
            "è¿™çœŸæ˜¯ä¸€å¨ç‹—å±ï¼Œå®Œå…¨æ— æ³•æ¥å—ã€‚",
            "è‡­ï¼ŒçœŸè‡­ï¼Œè‡­ä¸å¯é—»ï¼" "ä¾æ‰˜ç­”è¾©",
            "ä¸€å¨ç‹—å±!",
            "ğŸ’©ğŸ’©ğŸ’©",
            "è´Ÿåˆ†æ»šç²—ï¼ŒçœŸæ˜¯æµªè´¹æ—¶é—´ï¼",
        ],
    }

    eval_results = scorer.run(repo_url)

    detail = eval_results["è¯„åˆ†"]
    print("==> detail:", type(detail), detail)

    score_list = {e["åˆ†æ•°"] for e in detail.values()}
    mean_score = sum(score_list) / len(score_list)
    comment = random.choice(comments[int(round(mean_score))])

    description = eval_results["è¯„ä»·ä¸å»ºè®®"]

    # ç”Ÿæˆå›¾åƒ URL
    # image_filename = '1x1_ä¸€ä¸ªå°ä¼™å­åœ¨ç¬”è®°æœ¬ç”µè„‘é¢å‰ä¸“å¿ƒåœ°å†™ä»£ç .png'  # æ›¿æ¢ä¸ºæ‚¨çš„å›¾ç‰‡åç§°
    # image_url = f"http://localhost:5000/images/{image_filename}"

    return jsonify(
        {
            "score": mean_score,
            "comment": comment,
            "detail": detail,
            "description": description,
        }
    )


# æä¾›é™æ€æ–‡ä»¶
@app.route("/images/<path:filename>", methods=["GET"])
def send_image(filename):
    return send_from_directory(os.path.join(app.root_path, "images"), filename)


if __name__ == "__main__":
    app.run(debug=True)
